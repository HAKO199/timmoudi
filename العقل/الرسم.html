<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة الرسم للأطفال 🎨</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f2fbff; --panel:#ffffff; --muted:#6b7b8c;
    --brand1:#ff6b6b; --brand2:#ffd166; --brand3:#4cc9f0; --brand4:#80ed99;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,#eafeff,#ffffff);color:#052233;display:flex;flex-direction:column;min-height:100vh}
  header{background:linear-gradient(90deg,var(--brand3),var(--brand4));color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo .blob{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--brand1),var(--brand2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff}
  h1{margin:0;font-size:18px}
  .top-right{display:flex;gap:10px;align-items:center}
  .top-right input{padding:6px;border-radius:8px;border:0;width:160px}

  .wrap{display:grid;grid-template-columns:300px 1fr;gap:18px;padding:18px;align-items:start}
  @media(max-width:900px){.wrap{grid-template-columns:1fr} .left-panel{order:2}}

  .panel{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(10,20,30,0.06)}
  .left-panel .section{margin-bottom:12px}
  .label{font-weight:800;margin-bottom:8px}
  .colors{display:flex;flex-wrap:wrap;gap:8px}
  .swatch{width:36px;height:36px;border-radius:8px;cursor:pointer;border:2px solid rgba(0,0,0,0.06)}
  .swatch.selected{outline:3px solid rgba(0,0,0,0.06);transform:scale(1.06)}

  .tools{display:flex;flex-direction:column;gap:8px}
  .btn{padding:8px 10px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,#f6f9ff,#e9f7ff)}
  .btn.active{box-shadow:0 8px 20px rgba(11,105,255,0.08);border:1px solid rgba(11,105,255,0.12)}
  .range{width:100%}
  .stamps{display:flex;gap:8px;flex-wrap:wrap}
  .stamp{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;background:#fff;border:1px solid rgba(0,0,0,0.04)}
  .footer-note{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}

  /* canvas area */
  .canvas-area{display:flex;flex-direction:column;gap:10px}
  .stage{background:linear-gradient(180deg,#ffffff,#eef9ff);padding:12px;border-radius:12px;border:6px solid rgba(11,105,255,0.06);display:flex;flex-direction:column;align-items:center}
  canvas{border-radius:8px;background:#fff;touch-action:none}
  .action-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}

  /* gallery modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:999}
  .modal .content{width:95%;max-width:1000px;background:#fff;padding:12px;border-radius:10px;max-height:90vh;overflow:auto}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
  .thumb{background:#f6fbff;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:8px}
  .thumb img{width:100%;height:120px;object-fit:cover;border-radius:6px}

  /* small labels */
  small{color:var(--muted);display:block;margin-top:6px}
</style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="blob">ر</div>
      <div>
        <h1>لوحة الرسم للأطفال 🎨</h1>
        <div style="font-size:13px;opacity:.95">ارسم، الصق ملصقات، واحفظ لوحتك!</div>
      </div>
    </div>
    <div class="top-right">
      <input id="kidName" placeholder="اسم الطفل (اختياري)" />
      <button class="btn" id="saveNameBtn">حفظ</button>
    </div>
  </header>

  <div class="wrap">
    <!-- left panel: controls -->
    <aside class="panel left-panel">
      <div class="section">
        <div class="label">ألوان مرحة</div>
        <div class="colors" id="colorsRow">
          <!-- swatches injected -->
        </div>
      </div>

      <div class="section">
        <div class="label">أداة & حجم الفرشاة</div>
        <div class="tools">
          <div style="display:flex;gap:8px">
            <button class="btn active" id="drawTool">✏️ رسم</button>
            <button class="btn" id="eraserTool">🧽 ممحاة</button>
            <button class="btn" id="fillTool">🪣 تعبئة</button>
            <button class="btn" id="stampTool">📎 ملصق</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input type="range" id="sizeRange" min="1" max="80" value="8" class="range" />
            <div style="min-width:42px;text-align:center;font-weight:800" id="sizeLabel">8</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="label">ملصقات لطيفة</div>
        <div class="stamps" id="stampsRow">
          <!-- stamps -->
        </div>
        <small>انقر على ملصق ثم اضغط على القماش للصقه</small>
      </div>

      <div class="section">
        <div class="label">خلفيات سريعة</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="bgNone">خلفية فارغة</button>
          <button class="btn" id="bgDots">نقّاط</button>
          <button class="btn" id="bgGrid">شبكة</button>
          <button class="btn" id="bgSun">شمس</button>
        </div>
      </div>

      <div class="section">
        <div class="label">تحكم & حفظ</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="undoBtn">↶ تراجع</button>
          <button class="btn" id="redoBtn">↷ إعادة</button>
          <button class="btn" id="clearBtn">🗑️ مسح اللوحة</button>
          <button class="btn" id="saveBtn">⬇️ تنزيل صورة</button>
          <button class="btn" id="galleryBtn">🖼️ معرض</button>
        </div>
        <small>يُحفظ المعرض محليًا في المتصفح</small>
      </div>

      <div class="footer-note">مصمّم للأطفال — تشجيع الإبداع 😊</div>
    </aside>

    <!-- canvas area -->
    <section class="panel canvas-area">
      <div class="stage">
        <canvas id="paint" width="900" height="600"></canvas>
        <div class="action-row">
          <div style="font-weight:800">اسم اللوحة (اختياري):</div>
          <input id="artTitle" placeholder="مثلاً: لوحة الزهور" style="padding:6px;border-radius:6px;border:0" />
        </div>
        <div class="action-row">
          <small id="status">الحالة: جاهز للرسم ✨</small>
        </div>
      </div>
    </section>

    <!-- right panel: tools preview / tips -->
    <aside class="panel left-col">
      <div style="font-weight:900">نصائح</div>
      <ul style="margin-top:8px;color:var(--muted)">
        <li>انقر لاختيار اللون، حرّك شريط الحجم لاختيار سمك الفرشاة.</li>
        <li>اختر ملصقًا ثم اضغط مكانًا على القماش للصقه.</li>
        <li>اضغط "تنزيل" لحفظ عملك كصورة PNG.</li>
        <li>المعرض يخزّن صورك محليًا ويمكن حذفها لاحقًا.</li>
      </ul>
      <div style="margin-top:12px">
        <div style="font-weight:800">الطفل:</div>
        <div id="kidLabel" style="color:var(--muted);margin-top:6px">غير مسجّل</div>
      </div>
    </aside>
  </div>

  <!-- gallery modal -->
  <div class="modal" id="galleryModal">
    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>معرض اللوحات</h3>
        <div>
          <button class="btn" id="closeGalleryBtn">إغلاق</button>
          <button class="btn" id="clearGalleryBtn">حذف الكل</button>
        </div>
      </div>
      <div class="thumbs" id="thumbs"></div>
    </div>
  </div>

<script>
/* ====== إعداد اللوحة والأدوات ====== */
const canvas = document.getElementById('paint');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
let drawing=false, lastX=0, lastY=0;
let tool='draw'; // draw | eraser | stamp | fill
let color='#052233';
let size=8;
let selectedStamp=null;
let undoStack=[], redoStack=[];

/* helpers: set size display */
const sizeRange = document.getElementById('sizeRange'), sizeLabel=document.getElementById('sizeLabel');
sizeRange.addEventListener('input', ()=>{ size = Number(sizeRange.value); sizeLabel.textContent = size; });

/* responsive canvas fit (keeps internal resolution) */
function fitCanvas(){
  // keep user-chosen size; canvas element set in HTML; we can adapt CSS for smaller screens
  // no scaling to maintain crisp lines
}
fitCanvas();

/* draw line */
function drawLine(x1,y1,x2,y2, col, sz, composite='source-over'){
  ctx.save();
  ctx.globalCompositeOperation = composite;
  ctx.lineJoin='round';
  ctx.lineCap='round';
  ctx.strokeStyle = col;
  ctx.lineWidth = sz;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.restore();
}

/* push state for undo */
function pushState(){
  try{
    const data = canvas.toDataURL();
    undoStack.push(data);
    if(undoStack.length>50) undoStack.shift();
    redoStack = [];
  }catch(e){}
}

/* restore from dataURL */
function restoreState(dataURL){
  const img = new Image();
  img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); };
  img.src = dataURL;
}

/* start drawing */
function pointerDown(e){
  e.preventDefault();
  drawing=true;
  const [x,y] = getXY(e);
  lastX=x; lastY=y;
  if(tool==='stamp' && selectedStamp){
    pushState();
    drawStampAt(x,y,selectedStamp);
    saveToGalleryAuto();
    updateStatus('تم لصق ملصق ✓');
    drawing=false;
    return;
  }
  if(tool==='fill'){
    pushState();
    floodFill(Math.floor(x),Math.floor(y), hexToRgba(color));
    saveToGalleryAuto();
    updateStatus('تم التعبئة ✓');
    drawing=false;
    return;
  }
  pushState();
}

/* move */
function pointerMove(e){
  if(!drawing) return;
  const [x,y] = getXY(e);
  if(tool==='draw'){ drawLine(lastX,lastY,x,y,color,size); lastX=x; lastY=y; }
  else if(tool==='eraser'){ drawLine(lastX,lastY,x,y,'rgba(255,255,255,1)',size*1.8,'destination-out'); lastX=x; lastY=y; }
}

/* up */
function pointerUp(e){
  if(drawing){ drawing=false; saveToGalleryAuto(); updateStatus('تم الحفظ مؤقتًا'); }
}

/* get canvas coords */
function getXY(e){
  const rect = canvas.getBoundingClientRect();
  let clientX,clientY;
  if(e.touches && e.touches[0]){ clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
  else { clientX = e.clientX; clientY = e.clientY; }
  const x = (clientX - rect.left) * (canvas.width / rect.width);
  const y = (clientY - rect.top) * (canvas.height / rect.height);
  return [x,y];
}

/* event listeners for mouse & touch */
canvas.addEventListener('mousedown', pointerDown);
canvas.addEventListener('mousemove', pointerMove);
canvas.addEventListener('mouseup', pointerUp);
canvas.addEventListener('mouseout', ()=> drawing=false);
canvas.addEventListener('touchstart', pointerDown, {passive:false});
canvas.addEventListener('touchmove', pointerMove, {passive:false});
canvas.addEventListener('touchend', pointerUp, {passive:false});

/* tools buttons */
document.getElementById('drawTool').addEventListener('click', ()=> selectTool('draw'));
document.getElementById('eraserTool').addEventListener('click', ()=> selectTool('eraser'));
document.getElementById('stampTool').addEventListener('click', ()=> selectTool('stamp'));
document.getElementById('fillTool').addEventListener('click', ()=> selectTool('fill'));

function selectTool(t){
  tool=t;
  document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
  if(t==='draw') document.getElementById('drawTool').classList.add('active');
  if(t==='eraser') document.getElementById('eraserTool').classList.add('active');
  if(t==='stamp') document.getElementById('stampTool').classList.add('active');
  if(t==='fill') document.getElementById('fillTool').classList.add('active');
  updateStatus('أداة: ' + ({draw:'رسم',eraser:'ممحاة',stamp:'ملصق',fill:'تعبئة'}[t]));
}

/* color palette */
const palette = ['#052233','#FF6B6B','#FFB703','#FFD166','#06D6A0','#4CC9F0','#8ECAE6','#B5179E','#FF8FAB','#FFD8E0','#8FBC8F','#2b2d42'];
const colorsRow = document.getElementById('colorsRow');
palette.forEach(c=>{
  const d = document.createElement('div'); d.className='swatch'; d.style.background=c;
  d.addEventListener('click', ()=> { color=c; document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected')); d.classList.add('selected'); updateStatus('اللون اخترت'); });
  colorsRow.appendChild(d);
});
document.querySelectorAll('.swatch')[0].classList.add('selected');

/* stamps (emojis) */
const stamps = ['🌟','🐶','🐱','🌈','🍓','🚀','🌸','☀️','⭐️'];
const stampsRow = document.getElementById('stampsRow');
stamps.forEach(s=>{
  const el = document.createElement('div'); el.className='stamp'; el.textContent = s;
  el.addEventListener('click', ()=> { selectedStamp = s; selectTool('stamp'); updateStatus('اختر مكانًا لصق الملصق') });
  stampsRow.appendChild(el);
});

/* draw stamp */
function drawStampAt(x,y,s){
  ctx.save();
  ctx.font = `${Math.max(28, size*6)}px serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(s, x, y);
  ctx.restore();
}

/* background patterns */
document.getElementById('bgNone').addEventListener('click', ()=> clearBackground());
document.getElementById('bgDots').addEventListener('click', ()=> drawDotsBackground());
document.getElementById('bgGrid').addEventListener('click', ()=> drawGridBackground());
document.getElementById('bgSun').addEventListener('click', ()=> drawSunBackground());

function clearBackground(){
  pushState();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  updateStatus('خلفية فارغة');
}
function drawDotsBackground(){
  pushState();
  ctx.fillStyle='#fff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#e6f7ff';
  for(let x=20;x<canvas.width;x+=40){
    for(let y=20;y<canvas.height;y+=40){
      ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
    }
  }
  updateStatus('خلفية نقاط');
}
function drawGridBackground(){
  pushState();
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#e6eef7'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=30){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=30){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  updateStatus('خلفية شبكة');
}
function drawSunBackground(){
  pushState();
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  // sun top-right
  const cx = canvas.width - 120, cy = 120;
  const grad = ctx.createRadialGradient(cx,cy,10,cx,cy,120);
  grad.addColorStop(0,'#ffd166'); grad.addColorStop(1,'rgba(255,209,102,0.0)');
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(cx,cy,120,0,Math.PI*2); ctx.fill();
  updateStatus('خلفية شمس');
}

/* undo / redo */
document.getElementById('undoBtn').addEventListener('click', ()=> {
  if(undoStack.length===0) return;
  const last = undoStack.pop();
  redoStack.push(canvas.toDataURL());
  restoreState(last);
  updateStatus('تراجع');
});
document.getElementById('redoBtn').addEventListener('click', ()=> {
  if(redoStack.length===0) return;
  const nxt = redoStack.pop();
  undoStack.push(canvas.toDataURL());
  restoreState(nxt);
  updateStatus('إعادة');
});

/* clear canvas */
document.getElementById('clearBtn').addEventListener('click', ()=> {
  if(confirm('هل تريد مسح كامل اللوحة؟')){ pushState(); ctx.clearRect(0,0,canvas.width,canvas.height); saveToGalleryAuto(); updateStatus('اللوحة مُمسوحة'); }
});

/* save image (download) */
document.getElementById('saveBtn').addEventListener('click', ()=> {
  const title = document.getElementById('artTitle').value || 'my_art';
  const data = canvas.toDataURL('image/png');
  const a = document.createElement('a'); a.href = data; a.download = title + '.png'; a.click();
});

/* gallery modal */
const galleryModal = document.getElementById('galleryModal');
document.getElementById('galleryBtn').addEventListener('click', ()=> { showGallery(); });
document.getElementById('closeGalleryBtn').addEventListener('click', ()=> { galleryModal.style.display='none'; });
document.getElementById('clearGalleryBtn').addEventListener('click', ()=> { if(confirm('حذف كل الصور من المعرض؟')){ localStorage.removeItem('kids_paint_gallery'); renderGallery(); } });

function saveToGalleryAuto(){
  // save current canvas image to local gallery (only last version) - keep up to 50
  try{
    const data = canvas.toDataURL('image/png');
    const title = document.getElementById('artTitle').value || ('لوحة ' + new Date().toLocaleString());
    const gallery = JSON.parse(localStorage.getItem('kids_paint_gallery') || '[]');
    gallery.unshift({img:data, title, author:localStorage.getItem('kids_paint_name')||null, at:new Date().toISOString()});
    if(gallery.length>50) gallery.pop();
    localStorage.setItem('kids_paint_gallery', JSON.stringify(gallery));
    renderGalleryThumbs(gallery);
  }catch(e){}
}

function showGallery(){
  renderGallery();
  galleryModal.style.display='flex';
}
function renderGallery(){
  const gallery = JSON.parse(localStorage.getItem('kids_paint_gallery') || '[]');
  renderGalleryThumbs(gallery);
}
function renderGalleryThumbs(gallery){
  const thumbs = document.getElementById('thumbs'); thumbs.innerHTML='';
  gallery.forEach((g,i)=>{
    const div=document.createElement('div'); div.className='thumb';
    div.innerHTML = `<img src="${g.img}" alt="${g.title}"><div style="font-weight:800">${g.title}</div><small>من: ${g.author||'غير مسجل'}</small>`;
    const del = document.createElement('button'); del.className='btn'; del.textContent='حذف'; del.style.marginTop='6px';
    del.addEventListener('click', ()=> { if(confirm('حذف هذه الصورة؟')){ gallery.splice(i,1); localStorage.setItem('kids_paint_gallery', JSON.stringify(gallery)); renderGalleryThumbs(gallery); }});
    const dl = document.createElement('button'); dl.className='btn'; dl.textContent='تنزيل'; dl.style.marginTop='6px'; dl.style.marginLeft='6px';
    dl.addEventListener('click', ()=> { const a=document.createElement('a'); a.href=g.img; a.download=g.title+'.png'; a.click(); });
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.justifyContent='space-between'; wrap.style.marginTop='6px';
    wrap.appendChild(del); wrap.appendChild(dl);
    div.appendChild(wrap);
    thumbs.appendChild(div);
  });
}

/* auto-save initial blank state */
pushState();

/* save child name */
document.getElementById('saveNameBtn').addEventListener('click', ()=> {
  const n = document.getElementById('kidName').value.trim();
  if(n) { localStorage.setItem('kids_paint_name', n); document.getElementById('kidLabel').textContent = n; alert('تم حفظ اسم الطفل'); }
});

/* load saved name */
(function loadName(){
  const n = localStorage.getItem('kids_paint_name');
  if(n){ document.getElementById('kidName').value = n; document.getElementById('kidLabel').textContent = n; }
})();

/* status helper */
function updateStatus(msg){ document.getElementById('status').textContent = 'الحالة: ' + msg; }

/* simple flood fill algorithm (stack-based) */
function hexToRgba(hex){
  // supports #rrggbb or named color detection via temporary element
  if(/^#/.test(hex)){
    const r = parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return {r,g,b,a:255};
  } else {
    // fallback: draw pixel and read
    const prev = ctx.fillStyle;
    ctx.fillStyle = hex;
    ctx.fillRect(0,0,1,1);
    const d = ctx.getImageData(0,0,1,1).data;
    ctx.fillStyle = prev;
    return {r:d[0],g:d[1],b:d[2],a:d[3]};
  }
}
function colorsMatch(a,b){
  return a.r===b.r && a.g===b.g && a.b===b.b && a.a===b.a;
}
function floodFill(startX,startY,fillColor){
  const w = canvas.width, h = canvas.height;
  const img = ctx.getImageData(0,0,w,h);
  const data = img.data;
  const idx = (y,x) => (x + y*w)*4;
  const startIdx = idx(startY, startX);
  const baseColor = {r:data[startIdx], g:data[startIdx+1], b:data[startIdx+2], a:data[startIdx+3]};
  const newColor = fillColor;
  if(colorsMatch(baseColor,newColor)) return;
  const stack = [[startX,startY]];
  while(stack.length){
    const [x,y] = stack.pop();
    if(x<0 || x>=w || y<0 || y>=h) continue;
    const i = idx(Math.floor(y),Math.floor(x));
    const cur = {r:data[i],g:data[i+1],b:data[i+2],a:data[i+3]};
    if(!colorsMatch(cur, baseColor)) continue;
    data[i]=newColor.r; data[i+1]=newColor.g; data[i+2]=newColor.b; data[i+3]=255;
    stack.push([x+1,y]); stack.push([x-1,y]); stack.push([x,y+1]); stack.push([x,y-1]);
  }
  ctx.putImageData(img,0,0);
}

/* simple helper to convert rgb to hex (unused now) */
function rgbToHex(r,g,b){ return '#' + [r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }

/* init a small friendly background */
drawDotsBackground();
updateStatus('جاهز للرسم 🌈');

/* keyboard shortcuts (Z undo, Y redo, S save) */
window.addEventListener('keydown',(e)=>{
  if(e.ctrlKey && e.key.toLowerCase()==='z'){ document.getElementById('undoBtn').click(); }
  if(e.ctrlKey && e.key.toLowerCase()==='y'){ document.getElementById('redoBtn').click(); }
  if(e.key.toLowerCase()==='s' && e.ctrlKey){ e.preventDefault(); document.getElementById('saveBtn').click(); }
});

</script>
</body>
</html>
