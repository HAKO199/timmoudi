<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…ÙŠÙ„Ø© â€” ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©</title>
<style>
  :root{
    --bg:#fda000;
    --card:#7c4702;
    --accent:#b8860b; /* Ø¨Ù†ÙŠ Ø°Ù‡Ø¨ÙŠ */
    --accent-2:#d1a24a;
    --muted:#0054fc;
    --msg-me:#fff8e6;
    --msg-you:#ffffff;
    --radius:14px;
    --shadow: 0 8px 30px rgba(11,15,30,.07);
    --shadow-light: 0 4px 12px rgba(11,15,30,.05);
    --transition: all 0.3s ease;
    font-family: "Tajawal", "Segoe UI", Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#fbfbfc,var(--bg));color:#111}
  .wrap{max-width:980px;margin:28px auto;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:18px}
  .panel{background:var(--card);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† / Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª */
  .sidebar{display:flex;flex-direction:column;height:720px}
  .brand{padding:18px 16px;border-bottom:1px solid #f0f2f5;display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .brand h3{margin:0;font-size:16px}
  .search{padding:12px;border-bottom:1px solid #f0f2f5}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #eef3f7;background:#fbfdff;transition:var(--transition)}
  .search input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(184,134,11,0.1)}
  .conversations{padding:12px;overflow:auto;flex:1}
  .conv{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;cursor:pointer;transition:var(--transition)}
  .conv:hover{background:#fbf7ef;transform:translateY(-1px);box-shadow:var(--shadow-light)}
  .conv.active{background:#fbf7ef;border-right:3px solid var(--accent)}
  .avatar{width:46px;height:46px;border-radius:10px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:700;color:#6b4b10;transition:var(--transition)}
  .meta{flex:1}
  .meta h4{margin:0;font-size:14px}
  .meta p{margin:4px 0 0;font-size:13px;color:var(--muted)}
  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
  .chat{display:flex;flex-direction:column;height:720px}
  .chat-header{padding:12px 16px;border-bottom:1px solid #f0f2f5;display:flex;align-items:center;gap:12px}
  .chat-title{display:flex;flex-direction:column}
  .chat-title h3{margin:0;font-size:16px}
  .chat-title p{margin:2px 0 0;color:var(--muted);font-size:13px}
  .messages{padding:18px;flex:1;overflow:auto;background:
    linear-gradient(180deg, rgba(255,248,230,.4), transparent 40%);position:relative}
  .messages .day-sep{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;margin:8px 0}
  .msg{max-width:74%;margin:8px 0;padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(11,15,30,.04);display:inline-block;line-height:1.35;transition:var(--transition);animation:fadeIn 0.3s ease}
  .msg.me{margin-left:auto;background:var(--msg-me);border:1px solid rgba(180,130,20,.08);border-top-right-radius:4px}
  .msg.you{background:var(--msg-you);border:1px solid rgba(15,23,42,.03)}
  .msg .time{display:block;text-align:left;color:var(--muted);font-size:11px;margin-top:6px}
  .msg .status{display:inline-block;margin-right:4px;font-size:10px}
  .msg .status.read{color:var(--accent)}
  .msg .status.sent{color:var(--muted)}
  .typing{font-size:13px;color:var(--muted);padding:6px 10px;border-radius:999px;background:#fff;border:1px dashed #f0e6cf;display:inline-block;animation:pulse 1.5s infinite}
  .chat-input{padding:12px;border-top:1px solid #f0f2f5;display:flex;gap:10px;align-items:center}
  .input-box{flex:1;display:flex;gap:8px;background:linear-gradient(180deg,#fff,#fff);padding:10px;border-radius:12px;border:1px solid #eef3f7;transition:var(--transition)}
  .input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 2px rgba(184,134,11,0.1)}
  .input-box textarea{flex:1;border:0;outline:none;resize:none;font-size:15px;padding:4px;background:transparent;font-family:inherit;direction:rtl;max-height:120px}
  .btn{background:var(--accent);border:0;color:white;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 8px 18px rgba(181,132,32,.18);transition:var(--transition)}
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(181,132,32,.25)}
  .btn.secondary{background:#fff;border:1px solid #eee;color:#111;padding:9px 12px;box-shadow:none}
  .btn.secondary:hover{background:#f9f9f9;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.05)}
  .actions{display:flex;gap:8px;align-items:center}
  .emoji-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:6px;border-radius:8px;transition:var(--transition)}
  .emoji-btn:hover{background:#f5f5f5}
  .emoji-picker{position:absolute;bottom:70px;right:12px;background:white;border-radius:12px;box-shadow:var(--shadow);padding:12px;width:300px;z-index:10;display:none;grid-template-columns:repeat(8, 1fr);gap:6px}
  .emoji-picker.show{display:grid;animation:slideUp 0.2s ease}
  .emoji{font-size:18px;cursor:pointer;padding:4px;text-align:center;border-radius:6px;transition:var(--transition)}
  .emoji:hover{background:#f5f5f5;transform:scale(1.2)}
  .file-input{display:none}
  .file-preview{display:flex;align-items:center;gap:8px;padding:8px;background:#f9f9f9;border-radius:8px;margin-bottom:8px;font-size:13px}
  .file-preview .remove-file{background:none;border:none;cursor:pointer;color:var(--muted);font-size:16px}
  .context-menu{position:absolute;background:white;border-radius:8px;box-shadow:var(--shadow);padding:8px 0;z-index:100;display:none;min-width:150px}
  .context-menu.show{display:block;animation:fadeIn 0.2s ease}
  .context-menu button{width:100%;background:none;border:none;padding:8px 16px;text-align:right;cursor:pointer;transition:var(--transition)}
  .context-menu button:hover{background:#f5f5f5}
  /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:translateY(0)}
  }
  @keyframes pulse{
    0%{opacity:0.6}
    50%{opacity:1}
    100%{opacity:0.6}
  }
  @keyframes slideUp{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:translateY(0)}
  }
  /* mobile */
  @media (max-width:900px){
    .wrap{grid-template-columns:1fr;gap:10px;padding:12px}
    .sidebar{display:none}
    .chat{height:calc(100vh - 110px)}
    .msg{max-width:88%}
    .emoji-picker{width:280px;right:8px}
  }
  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© */
  .online-indicator{width:10px;height:10px;border-radius:50%;background:#10b981;margin-left:8px}
  .offline-indicator{width:10px;height:10px;border-radius:50%;background:#ef4444;margin-left:8px}
  .typing-indicator{display:flex;align-items:center;gap:4px;margin-bottom:8px}
  .typing-dots{display:flex;gap:2px}
  .typing-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);animation:typing 1.4s infinite ease-in-out}
  .typing-dot:nth-child(1){animation-delay:-0.32s}
  .typing-dot:nth-child(2){animation-delay:-0.16s}
  @keyframes typing{
    0%, 80%, 100%{transform:scale(0.8);opacity:0.5}
    40%{transform:scale(1);opacity:1}
  }
</style>
</head>
<body>

<div class="wrap">
  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ø§Ø¯Ø«Ø§Øª) -->
  <aside class="panel sidebar" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª">
    <div class="brand">
      <div class="logo">Ø¯Ø´</div>
      <div>
        <h3>Ø¯Ø±Ø¯Ø´Ø© </h3>
        <div style="font-size:12px;color:var(--muted)">Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</div>
      </div>
    </div>

    <div class="search">
      <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ùˆ Ø§Ø³Ù…..." />
    </div>

    <div class="conversations" id="convList" tabindex="0" aria-live="polite">
      <!-- Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØªÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
    </div>
  </aside>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
  <main class="panel chat" aria-label="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
    <div class="chat-header">
      <div class="avatar" id="chatAvatar">Ø¬</div>
      <div class="chat-title">
        <h3 id="chatName">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
        <p id="chatStatus"><span class="online-indicator"></span> Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</p>
      </div>
      <div style="margin-inline-start:auto" class="actions">
        <button class="btn secondary" id="clearBtn" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">Ù…Ø³Ø­</button>
        <button class="btn" id="exportBtn" title="Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">ØªØµØ¯ÙŠØ±</button>
      </div>
    </div>

    <div class="messages" id="messages" role="log" aria-live="polite">
      <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    </div>

    <div class="chat-input">
      <div class="input-box" role="textbox" aria-multiline="true">
        <div id="filePreviews"></div>
        <textarea id="messageInput" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©... (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„, Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"></textarea>
        <button class="emoji-btn" id="emojiBtn" title="Ø¥Ø¶Ø§ÙØ© Ø±Ù…Ø² ØªØ¹Ø¨ÙŠØ±ÙŠ">ğŸ˜Š</button>
        <input type="file" id="fileInput" class="file-input" multiple accept="image/*,.pdf,.doc,.docx,.txt">
        <button class="btn secondary" id="attachBtn" title="Ø¥Ø±ÙØ§Ù‚ (ØµÙˆØ±Ø©/Ù…Ù„Ù)">ğŸ“</button>
      </div>
      <div class="actions">
        <button class="btn" id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
    
    <!-- Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© -->
    <div class="emoji-picker" id="emojiPicker"></div>
    
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="context-menu" id="contextMenu">
      <button id="replyMsgBtn">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
      <button id="editMsgBtn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
      <button id="deleteMsgBtn">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
    </div>
  </main>
</div>

<script>
/*
  Simple Chat Widget (Frontend only)
  - ÙŠØ­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ localStorage
  - ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ù€ Enter (Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)
  - Ø¯ÙˆØ§Ù„ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø±Ø¨Ø· Ø¨Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± WebSocket Ø£Ùˆ REST
*/

// Ø¹Ù†Ø§ØµØ± DOM
const convListEl = document.getElementById('convList');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const searchInput = document.getElementById('searchInput');
const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('emojiPicker');
const fileInput = document.getElementById('fileInput');
const attachBtn = document.getElementById('attachBtn');
const filePreviews = document.getElementById('filePreviews');
const contextMenu = document.getElementById('contextMenu');
const replyMsgBtn = document.getElementById('replyMsgBtn');
const editMsgBtn = document.getElementById('editMsgBtn');
const deleteMsgBtn = document.getElementById('deleteMsgBtn');

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
const STORAGE_KEY = 'site_chat_messages_v2';
const currentConversationId = 'global'; // Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ùˆ Ø£Ø±Ø¯Øª Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
let selectedFiles = [];
let selectedMessageId = null;
let isEditing = false;

// Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ù…ÙˆØ² ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø£Ø³Ø§Ø³ÙŠØ©
const emojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾'];

// ØªÙ‡ÙŠØ¦Ø© Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ©
function initEmojiPicker() {
  emojis.forEach(emoji => {
    const emojiEl = document.createElement('div');
    emojiEl.className = 'emoji';
    emojiEl.textContent = emoji;
    emojiEl.addEventListener('click', () => {
      inputEl.value += emoji;
      inputEl.focus();
    });
    emojiPicker.appendChild(emojiEl);
  });
}

// ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚
function initContextMenu() {
  // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†
  document.addEventListener('click', () => {
    contextMenu.classList.remove('show');
  });
  
  // Ù…Ù†Ø¹ Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡Ø§
  contextMenu.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  replyMsgBtn.addEventListener('click', () => {
    if (selectedMessageId) {
      const msg = findMessageById(selectedMessageId);
      if (msg) {
        inputEl.value = `Ø±Ø¯ Ø¹Ù„Ù‰ "${msg.text.substring(0, 30)}${msg.text.length > 30 ? '...' : ''}": `;
        inputEl.focus();
      }
      contextMenu.classList.remove('show');
    }
  });
  
  editMsgBtn.addEventListener('click', () => {
    if (selectedMessageId) {
      const msg = findMessageById(selectedMessageId);
      if (msg && msg.from === 'me') {
        inputEl.value = msg.text;
        inputEl.focus();
        isEditing = true;
        sendBtn.textContent = 'ØªØ­Ø¯ÙŠØ«';
      }
      contextMenu.classList.remove('show');
    }
  });
  
  deleteMsgBtn.addEventListener('click', () => {
    if (selectedMessageId && confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
      deleteMessage(selectedMessageId);
      contextMenu.classList.remove('show');
    }
  });
}

// Ù†Ù…ÙˆØ°Ø¬ Ø±Ø³Ø§Ù„Ø©
function makeMsg(text, from='me', files=[]){
  return {
    id: 'm_' + Date.now() + '_' + Math.floor(Math.random()*1000),
    from,
    text,
    files: [...files],
    ts: new Date().toISOString(),
    status: from === 'me' ? 'sent' : 'delivered'
  };
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
function loadMessages(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY) || '{}';
    const all = JSON.parse(raw);
    return all[currentConversationId] || [];
  }catch(e){
    console.error(e);
    return [];
  }
}

// Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function saveMessages(arr){
  try{
    const raw = localStorage.getItem(STORAGE_KEY) || '{}';
    const all = JSON.parse(raw);
    all[currentConversationId] = arr;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
  }catch(e){
    console.error(e);
  }
}

// Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¹Ø±Ù
function findMessageById(id) {
  const messages = loadMessages();
  return messages.find(msg => msg.id === id);
}

// Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©
function deleteMessage(id) {
  const messages = loadMessages();
  const updatedMessages = messages.filter(msg => msg.id !== id);
  saveMessages(updatedMessages);
  renderAll();
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
function renderMessage(msg){
  const div = document.createElement('div');
  div.className = 'msg ' + (msg.from === 'me' ? 'me' : 'you');
  div.dataset.id = msg.id;
  
  // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø£ÙŠÙ…Ù†
  div.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    selectedMessageId = msg.id;
    contextMenu.style.top = `${e.clientY}px`;
    contextMenu.style.left = `${e.clientX}px`;
    contextMenu.classList.add('show');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    editMsgBtn.style.display = msg.from === 'me' ? 'block' : 'none';
  });
  
  // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  const content = document.createElement('div');
  content.innerHTML = escapeHtml(msg.text).replace(/\\n/g,'<br>');
  div.appendChild(content);
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
  if (msg.files && msg.files.length > 0) {
    msg.files.forEach(file => {
      const fileEl = document.createElement('div');
      fileEl.className = 'file-preview';
      fileEl.innerHTML = `
        <span>ğŸ“ ${file.name}</span>
        <button class="remove-file" onclick="downloadFile('${file.data}', '${file.name}')">ğŸ“¥</button>
      `;
      div.appendChild(fileEl);
    });
  }
  
  // Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  const footer = document.createElement('div');
  footer.style.display = 'flex';
  footer.style.justifyContent = 'space-between';
  footer.style.alignItems = 'center';
  footer.style.marginTop = '6px';
  
  const t = document.createElement('span');
  t.className = 'time';
  t.textContent = formatTime(msg.ts);
  footer.appendChild(t);
  
  if (msg.from === 'me') {
    const status = document.createElement('span');
    status.className = `status ${msg.status}`;
    status.textContent = msg.status === 'read' ? 'âœ“âœ“' : 'âœ“';
    footer.appendChild(status);
  }
  
  div.appendChild(footer);
  return div;
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù
function downloadFile(data, filename) {
  const link = document.createElement('a');
  link.href = data;
  link.download = filename;
  link.click();
}

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© Ø¬Ù…ÙŠÙ„Ø©
function formatTime(iso){
  const d = new Date(iso);
  const hh = d.getHours().toString().padStart(2,'0');
  const mm = d.getMinutes().toString().padStart(2,'0');
  return hh + ':' + mm;
}

// ØªØ±Ù…ÙŠØ² Ù…Ø­ØªÙˆÙ‰ HTML Ù„Ù…Ù†Ø¹ XSS
function escapeHtml(unsafe) {
  return unsafe
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/\"/g, "&quot;")
       .replace(/'/g, "&#039;");
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function renderAll(){
  messagesEl.innerHTML = '';
  const arr = loadMessages();
  if(arr.length === 0){
    const n = document.createElement('div');
    n.className = 'day-sep';
    n.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù† âœ¨';
    messagesEl.appendChild(n);
    return;
  }
  
  // Ø¥Ø¶Ø§ÙØ© ÙÙˆØ§ØµÙ„ Ø²Ù…Ù†ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  let lastDate = null;
  arr.forEach(m => {
    const msgDate = new Date(m.ts).toDateString();
    if (lastDate !== msgDate) {
      const dateSep = document.createElement('div');
      dateSep.className = 'day-sep';
      dateSep.textContent = formatDate(m.ts);
      messagesEl.appendChild(dateSep);
      lastDate = msgDate;
    }
    messagesEl.appendChild(renderMessage(m));
  });
  
  // Ø£Ø°Ù‡Ø¨ Ù„Ø£Ø³ÙÙ„
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(iso) {
  const d = new Date(iso);
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  if (d.toDateString() === today.toDateString()) {
    return 'Ø§Ù„ÙŠÙˆÙ…';
  } else if (d.toDateString() === yesterday.toDateString()) {
    return 'Ø£Ù…Ø³';
  } else {
    return d.toLocaleDateString('ar-SA');
  }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ©
function sendLocal(text, files = []){
  if((!text || !text.trim()) && files.length === 0) return;
  
  const arr = loadMessages();
  
  if (isEditing && selectedMessageId) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const msgIndex = arr.findIndex(msg => msg.id === selectedMessageId);
    if (msgIndex !== -1) {
      arr[msgIndex].text = text.trim();
      arr[msgIndex].ts = new Date().toISOString();
      saveMessages(arr);
      renderAll();
      resetInput();
    }
  } else {
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    const msg = makeMsg(text.trim(),'me', files);
    arr.push(msg);
    saveMessages(arr);
    renderAll();
    resetInput();

    // Ù…Ø«Ø§Ù„: Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø³ÙŠØ· Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© (ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡Ø§ Ø£Ùˆ Ø±Ø¨Ø· API)
    fakeReplySim(text, files);
  }
}

// Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ø¯ (Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·)
function fakeReplySim(userText, userFiles){
  // Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©ØŒ Ø£Ø¹Ø¯ return
  setTimeout(()=>{
    const reply = userFiles.length > 0 
      ? `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ${userFiles.length} Ù…Ù„Ù(Ù…Ù„ÙØ§Øª)`
      : `ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: "${userText.slice(0,60)}"`;
    
    const arr = loadMessages();
    arr.push(makeMsg(reply,'you'));
    saveMessages(arr);
    renderAll();
  }, 900);
}

// Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
function clearConversation(){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) return;
  const raw = localStorage.getItem(STORAGE_KEY) || '{}';
  const all = JSON.parse(raw);
  all[currentConversationId] = [];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
  renderAll();
}

// ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©)
function loadConversationsList(){
  const demo = [
    {id:'global', name:'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©', preview:'Ù…Ø±Ø­Ø¨Ù‹Ø§ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', unread: 0, online: true},
    {id:'team', name:'ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù…', preview:'Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©', unread: 2, online: true},
    {id:'sales', name:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', preview:'Ø§Ø³ØªÙØ³Ø§Ø± Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬', unread: 0, online: false}
  ];
  convListEl.innerHTML = '';
  demo.forEach(c => {
    const el = document.createElement('div');
    el.className = 'conv' + (c.id === currentConversationId ? ' active' : '');
    el.onclick = ()=> selectConversation(c.id, c.name);
    el.innerHTML = `
      <div class="avatar">${c.name.charAt(0)}</div>
      <div class="meta">
        <h4>${c.name} ${c.unread > 0 ? `<span style="background:var(--accent);color:white;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:10px;margin-right:4px">${c.unread}</span>` : ''}</h4>
        <p>${c.preview}</p>
      </div>
      <div class="${c.online ? 'online-indicator' : 'offline-indicator'}"></div>
    `;
    convListEl.appendChild(el);
  });
}

// ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø© (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù† ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€” Ù„ØªÙˆØ³ÙŠØ¹Ù‡Ø§ ØªØ­ØªØ§Ø¬ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª)
function selectConversation(id,name){
  // ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ù†Ù‚ÙˆÙ… ÙÙ‚Ø· Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ø®Ø²Ù†Ø© ÙÙŠ currentConversationId Ø§Ù„Ø«Ø§Ø¨Øª)
  document.getElementById('chatName').textContent = name || 'Ù…Ø­Ø§Ø¯Ø«Ø©';
  document.getElementById('chatAvatar').textContent = (name||'Ù…').charAt(0);
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©
  Array.from(convListEl.children).forEach(child => {
    child.classList.remove('active');
    if (child.querySelector('h4').textContent.includes(name)) {
      child.classList.add('active');
    }
  });
  
  // Ù„Ùˆ Ø£Ø±Ø¯Øª ØªØºÙŠÙŠØ± currentConversationId Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§: Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
  // (Ù„ÙŠØ³ Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ø§Ù„Ø´ÙŠÙØ±Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù‡Ø°Ù‡)
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
function resetInput() {
  inputEl.value = '';
  selectedFiles = [];
  filePreviews.innerHTML = '';
  isEditing = false;
  selectedMessageId = null;
  sendBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„';
  inputEl.focus();
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©
function handleFileSelect(e) {
  const files = Array.from(e.target.files);
  selectedFiles = [...selectedFiles, ...files];
  
  // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª
  filePreviews.innerHTML = '';
  selectedFiles.forEach((file, index) => {
    const preview = document.createElement('div');
    preview.className = 'file-preview';
    preview.innerHTML = `
      <span>ğŸ“ ${file.name}</span>
      <button class="remove-file" onclick="removeFile(${index})">âœ•</button>
    `;
    filePreviews.appendChild(preview);
  });
}

// Ø¥Ø²Ø§Ù„Ø© Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function removeFile(index) {
  selectedFiles.splice(index, 1);
  handleFileSelect({target: {files: []}}); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
}

// ØªØ¹Ø±ÙŠØ¨ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­: Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„, Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
inputEl.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});

// Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
sendBtn.addEventListener('click', ()=>{
  const text = inputEl.value;
  sendLocal(text, selectedFiles);
});

// Ø²Ø± Ø§Ù„Ù…Ø³Ø­
clearBtn.addEventListener('click', clearConversation);

// Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± (ÙŠØ­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙƒÙ…Ù„Ù Ù†ØµÙŠ)
exportBtn.addEventListener('click', ()=>{
  const arr = loadMessages();
  const content = arr.map(m => {
    const date = new Date(m.ts).toLocaleString('ar-SA');
    return `[${date}] ${m.from === 'me' ? 'Ø£Ù†Ø§' : 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±'}: ${m.text}${m.files.length > 0 ? ` [${m.files.length} Ù…Ù„Ù(Ù…Ù„ÙØ§Øª)]` : ''}`;
  }).join('\n');
  
  const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'chat_export.txt';
  a.click();
  URL.revokeObjectURL(url);
});

// Ø²Ø± Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ©
emojiBtn.addEventListener('click', () => {
  emojiPicker.classList.toggle('show');
});

// Ø²Ø± Ø§Ù„Ø¥Ø±ÙØ§Ù‚
attachBtn.addEventListener('click', () => {
  fileInput.click();
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª
fileInput.addEventListener('change', handleFileSelect);

// Ø¨Ø­Ø« Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
searchInput.addEventListener('input', ()=>{
  const q = searchInput.value.trim().toLowerCase();
  Array.from(convListEl.children).forEach(item=>{
    const txt = item.textContent.toLowerCase();
    item.style.display = txt.includes(q) ? '' : 'none';
  });
});

// Ø¥Ø®ÙØ§Ø¡ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e) => {
  if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
    emojiPicker.classList.remove('show');
  }
});

// Ø¯ÙˆØ§Ù„ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø±Ø¨Ø· Ø¨Ø®Ø§Ø¯ÙˆÙ…
// sendToServer(messageObject) { ... }  // Ù…Ø«Ø§Ù„: POST /api/messages
// connectSocket() { ... }  // Ù…Ø«Ø§Ù„: WebSocket Ù„ÙˆØ¸ÙŠÙØ© Ø¯Ø±Ø¯Ø´Ø© ÙØ¹Ù„ÙŠØ© Ø¨Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ

// Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„
initEmojiPicker();
initContextMenu();
loadConversationsList();
renderAll();

// Optional: Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙ‘Ø± Ø§Ù„Ù€ localStorage Ù…Ù† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ø¹Ù…Ù„ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
window.addEventListener('storage', (e)=>{
  if(e.key === STORAGE_KEY) renderAll();
});
</script>
</body>
</html>

